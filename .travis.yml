language: c
compiler:
  - gcc
  - clang

# Requring sudo as a work around for https://github.com/travis-ci/travis-ci/issues/8082
sudo: false
dist: trusty

addons:
  apt:
    packages:
      - autoconf-archive
      - dbus
      - dbus-x11
      - cmake
      - lcov
      - libgcrypt20-dev
      - libglib2.0-dev
      - libdbus-1-dev
      - liburiparser-dev
      - realpath
  coverity_scan:
    project:
      name: 01org/tpm2-abrmd
      description: Build submitted via Travis-CI
    notification_email: flihp@twobit.us
    build_command_prepend: "./bootstrap && ./configure"
    build_command: "make --jobs=$(nproc)"
    branch_pattern: coverity_scan

env:
  global:
    # COVERITY_SCAN_TOKEN created by coverity using 'travis encrypt' using
    # project repo public key
    - secure: "obb9XbzVIj7P/wBKXG6GIRlGSXFcQhTvAa6LX8wU279wt3t0uGakofOmw5SpFX9wnxCu6xd3yHaiUqAuFotf5Bb/ROfeqZGdBFUVSwmxEohzrxPH3KbYhd3lzACUSMNYBVwu+WZhzPK3cQRf8KtQw7V9qNP5qV+RfgXizo+r04w6g2hP8xeYIrJ86PUtLjFrvtd/OxXhWWb7i+dTDSSmUvdYi18XSyvtz+7H2OXJLZSO7Ns2WUAplkwre1pCgv2sg0pkxHQjjeIYEcvYZskiKsyyXT2AXZFTNa7KN51/N4lpk/Hb7ffjFMM9T6/NZ1JVY3UVpGOGYH4TM49macyws9b0RiwGpzW2qe2EKoiXLOEYk5erW/PoIM8PiNcvAgvQaU25/cZSDQaEn/S9DTLkC8AJHVmqY9tp9XVmesCrBhpeAnyDTAfiZ1t05HiFOqw7ByP1LM49ysvQk1cdlt28AvB90t6rttGUP8CUtwnasHOVASlZ/No7xRGFHlLLmfKVrZc31jZS4RHxthn4MKATzqkylMZQMVA2/jasRcfYTXiUPGUfuaxZfofSTpJANrGWAMC43FWqKi3jPVJ2/TdqZ2r/wXkK23SiF9Lu9X4QOGuLnbAuQENddqb1A3e2PH+0NC6O0ThWq69BcWmrtbD2ev0UDivbG8OQ1ZsSDm9UqVA="
    # run coverity scan on gcc build to keep from DOSing coverity
    - coverity_scan_run_condition='"$CC" = gcc'
    - PREFIX=/usr
    - DEPS="${TRAVIS_BUILD_DIR}/deps"
    - DESTDIR="${TRAVIS_BUILD_DIR}/destdir"
    - ACLOCAL_PATH="${DESTDIR}${PREFIX}/share/aclocal:${ACLOCAL_PATH}"
    - PKG_CONFIG_PATH="${DESTDIR}${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
    - LD_LIBRARY_PATH="${DESTDIR}${PREFIX}/lib:${LD_LIBRARY_PATH}"
    - CFLAGS="-I${DESTDIR}${PREFIX}/include"
    - CMOCKA_LIBS="-L${DESTDIR}${PREFIX}/lib -lcmocka"

install:
  - pip install --user cpp-coveralls
  - mkdir ${DESTDIR} ${DEPS} && pushd ${DEPS}
  - wget http://ftpmirror.gnu.org/autoconf-archive/autoconf-archive-2017.09.28.tar.xz
  - sha256sum autoconf-archive-2017.09.28.tar.xz | grep -q 5c9fb5845b38b28982a3ef12836f76b35f46799ef4a2e46b48e2bd3c6182fa01
  - tar xJf autoconf-archive-2017.09.28.tar.xz && pushd autoconf-archive-2017.09.28
  - ./configure --prefix=${PREFIX} && make && make install
  - popd # autoconf-archive
  - wget http://mirror.twobit.us/tpm2-deps/cmocka-1.1.1.tar.xz
  - tar -Jxvf cmocka-1.1.1.tar.xz
  - mkdir cmocka-1.1.1/build && pushd cmocka-1.1.1/build
  - cmake ../ -DCMAKE_INSTALL_PREFIX=${PREFIX} -DCMAKE_BUILD_TYPE=Release
  - make -j$(nproc) install
  - popd # cmocka
  - git clone -b master --single-branch https://github.com/01org/tpm2-tss.git
  - pushd tpm2-tss
  - ./bootstrap
  - ./configure --prefix=${PREFIX}
  - make -j$(nproc) install
  - popd # tpm2-tss
  - sed -i -e "s&\(\/usr\/lib\/lib.*\.la\)&${DESTDIR}\1&" ${DESTDIR}${PREFIX}/lib/*.la
  - wget http://mirror.twobit.us/tpm2-deps/ibmtpm974.tar.gz
  - sha256sum ibmtpm974.tar.gz | grep -q ^8e45d86129a0adb95fee4cee51f4b1e5b2d81ed3e55af875df53f98f39eb7ad7
  - mkdir ibmtpm
  - tar axf ibmtpm974.tar.gz -C ibmtpm
  - make -C ibmtpm/src -j$(nproc)
  - popd # ${DEPS}

before_script:
  - ./bootstrap

script :
# short-circuit normal build if we've already done a coverity scan
  - |
    if [ "${COVERITY_SCAN_BRANCH}" == 1 ]; then
        echo "COVERITY_SCAN_BRANCH set, not running normal build."
        exit 0
    fi
  - echo 'Configuring source code...' && echo -en 'travis_fold:start:tabrmd-configure\\r'
  - |
    CONFIGURE_OPTIONS="--disable-dlclose --enable-unit --with-simulatorbin=${DEPS}/ibmtpm/src/tpm_server"
    if [ "$CC" = "gcc" ]; then
        CONFIGURE_OPTIONS="$CONFIGURE_OPTIONS --enable-code-coverage"
    fi
    ./configure ${CONFIGURE_OPTIONS}
  - echo -en 'travis_fold:end:tabrmd-configure\\r'
  - echo "Running make 'distcheck' target..." && echo -en 'travis_fold:start:tabrmd-distcheck\\r'
  - dbus-launch make -j$(nproc) distcheck
  - echo -en 'travis_fold:end:tabrmd-distcheck\\r'
  - echo "Running make 'check-code-coverage' target..." && echo -en 'travis_fold:start:tabrmd-check-code-coverage\\r'
  - dbus-launch make -j$(nproc) check-code-coverage
  - |
    if [ \( "$CC" = "gcc" \) -a \( ! -z "$COVERALLS_REPO_TOKEN" \) ]; then
        echo "Uploading test coverage metrics to coveralls."
        coveralls --build-root=./ --exclude=${DEPS} --exclude=${DESTDIR} --exclude=./test --exclude=tpm2-abrmd-$(cat VERSION) --exclude=./coverity --exclude=./src/tabrmd-generated.c --exclude=./src/tabrmd-generated.h --gcov-options '\-lp'
    fi
  - echo -en 'travis_fold:end:tabrmd-check-code-coverage\\r'
  - echo 'Dumping unit test logs...' && echo -en 'travis_fold:start:tabrmd-unit-logs\\r'
  - |
    cat test-suite*.log
    for LOG in $(ls -1 test/*.log); do
        echo "${LOG}"
        cat ${LOG}
    done
  - echo -en 'travis_fold:end:tabrmd-unit-logs\\r'
